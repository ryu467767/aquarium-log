import csv
from pathlib import Path
from sqlmodel import select
from .db import session
from .models import Aquarium

FIELDS = [
    "name",
    "prefecture",
    "city",
    "location_raw",
    "url",
    "mola_star",
    "lat",
    "lng",
]


def import_csv(csv_path: str) -> int:
    p = Path(csv_path)
    if not p.exists():
        raise FileNotFoundError(csv_path)

    # Excel対策で utf-8-sig を優先
    with p.open("r", encoding="utf-8-sig", newline="") as f:
        reader = csv.DictReader(f)
        missing = [c for c in ["name"] if c not in (reader.fieldnames or [])]
        if missing:
            raise ValueError(f"CSV missing columns: {missing}")

        inserted = 0
        with session() as db:
            for row in reader:
                data = {k: (row.get(k, "") or "").strip() for k in FIELDS if k in row}
                if not data.get("name"):
                    continue
                # mola_star は int 化
                try:
                    data["mola_star"] = int(data.get("mola_star") or 0)
                except Exception:
                    data["mola_star"] = 0
                    # lat/lng を float 化
                try:
                    data["lat"] = float(data.get("lat")) if data.get("lat") else None
                except Exception:
                    data["lat"] = None

                try:
                    data["lng"] = float(data.get("lng")) if data.get("lng") else None
                except Exception:
                    data["lng"] = None


                # 既存チェック（uqに合わせる）
                exists = db.exec(
                    select(Aquarium).where(
                        Aquarium.name == data["name"],
                        Aquarium.location_raw == data.get("location_raw", ""),
                        Aquarium.url == data.get("url", ""),
                    )
                ).first()
                if exists:
                    # 情報更新したい場合はここで上書き可（いまはスキップ）
                    continue

                db.add(Aquarium(**data))
                inserted += 1

            db.commit()

        return inserted

if __name__ == "__main__":
    import argparse
    ap = argparse.ArgumentParser()
    ap.add_argument("csv_path")
    args = ap.parse_args()
    n = import_csv(args.csv_path)
    print(f"imported: {n}")
